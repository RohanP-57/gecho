rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Admin users collection - allow read for authentication, write for admins only
    match /admin_users/{userId} {
      allow read: if true; // Allow reading for authentication
      allow write: if request.auth != null && 
        exists(/databases/$(database)/documents/admin_users/$(request.auth.uid));
    }
    
    // Student users collection - allow read for authentication, write for students/admins
    match /student_users/{userId} {
      allow read: if true; // Allow reading for authentication
      allow write: if request.auth != null && 
        (request.auth.uid == userId || 
         exists(/databases/$(database)/documents/admin_users/$(request.auth.uid)));
      
      // Student posts subcollection - only clubs and admins can post
      match /posts/{postId} {
        allow read: if request.auth != null;
        allow write: if false; // Students cannot post based on requirements
        
        // Comments on student posts
        match /comments/{commentId} {
          allow read: if request.auth != null;
          allow create: if request.auth != null;
          allow update, delete: if request.auth != null && 
            (request.auth.uid == resource.data.authorId || 
             exists(/databases/$(database)/documents/admin_users/$(request.auth.uid)));
        }
      }
    }
    
    // Club users collection - allow read for authentication, write for clubs/admins
    match /club_users/{userId} {
      allow read: if true; // Allow reading for authentication
      allow write: if request.auth != null && 
        (request.auth.uid == userId || 
         exists(/databases/$(database)/documents/admin_users/$(request.auth.uid)));
      
      // Club posts subcollection - clubs can post
      match /posts/{postId} {
        allow read: if request.auth != null;
        allow write: if request.auth != null && request.auth.uid == userId;
        
        // Comments on club posts
        match /comments/{commentId} {
          allow read: if request.auth != null;
          allow create: if request.auth != null;
          allow update, delete: if request.auth != null && 
            (request.auth.uid == resource.data.authorId || 
             exists(/databases/$(database)/documents/admin_users/$(request.auth.uid)));
        }
      }
    }
    
    // Approved users - allow read for registration check, write for admins only
    match /approved_users/{email} {
      allow read: if true; // Allow reading for registration validation
      allow write: if request.auth != null && 
        exists(/databases/$(database)/documents/admin_users/$(request.auth.uid));
    }
    
    // Registration requests - users can create, admins can manage
    match /registration_requests/{email} {
      allow read: if true; // Allow reading for admin approval screen
      allow write: if request.auth != null && 
        exists(/databases/$(database)/documents/admin_users/$(request.auth.uid));
      allow create: if true; // Allow creating registration requests
    }
    
    // Global posts collection - everyone can read, clubs and admins can write
    match /posts/{postId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null && 
        (exists(/databases/$(database)/documents/club_users/$(request.auth.uid)) ||
         exists(/databases/$(database)/documents/admin_users/$(request.auth.uid)));
      allow update: if request.auth != null && 
        (request.auth.uid == resource.data.authorId ||
         exists(/databases/$(database)/documents/admin_users/$(request.auth.uid)));
      allow delete: if request.auth != null && 
        (request.auth.uid == resource.data.authorId ||
         exists(/databases/$(database)/documents/admin_users/$(request.auth.uid)));
      
      // Comments on global posts
      match /comments/{commentId} {
        allow read: if request.auth != null;
        allow create: if request.auth != null;
        allow update, delete: if request.auth != null && 
          (request.auth.uid == resource.data.authorId || 
           exists(/databases/$(database)/documents/admin_users/$(request.auth.uid)));
      }
    }
    
    // Legacy users collection (for backward compatibility during migration)
    match /users/{userId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && request.auth.uid == userId;
    }
  }
}

// Firebase Storage rules
service firebase.storage {
  match /b/{bucket}/o {
    // Allow read access to all files
    allow read: if true;
    
    // Allow write access to all files (for development - restrict in production)
    allow write: if true;
  }
}